services:
  rabbitmq:
    image: rabbitmq:3.13-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: cruise
      POSTGRES_PASSWORD: cruise
      POSTGRES_DB: cruise
    volumes:
      - ./postgres-data:/var/lib/postgresql/data

  ship-service:
    build: ../services/ship-service
    environment:
      SERVICE_NAME: ship-service
      JWT_SECRET: dev-secret-change-me
      CONTROL_PLANE_DATABASE_URL: postgresql+psycopg://cruise:cruise@postgres:5432/cruise
      POSTGRES_ADMIN_DSN: postgresql://cruise:cruise@postgres:5432/postgres
    ports:
      - "8001:8000"

  cruise-service:
    build: ../services/cruise-service
    environment:
      SERVICE_NAME: cruise-service
      JWT_SECRET: dev-secret-change-me
    ports:
      - "8002:8000"

  customer-service:
    build: ../services/customer-service
    environment:
      SERVICE_NAME: customer-service
      JWT_SECRET: dev-secret-change-me
      CONTROL_PLANE_DATABASE_URL: postgresql+psycopg://cruise:cruise@postgres:5432/cruise
      TENANT_DATABASE_URL_TEMPLATE: postgresql+psycopg://cruise:cruise@postgres:5432/{db}
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      EVENTS_EXCHANGE: cruise.events
    depends_on:
      - postgres
      - rabbitmq
      - ship-service
    ports:
      - "8003:8000"

  pricing-service:
    build: ../services/pricing-service
    environment:
      SERVICE_NAME: pricing-service
      JWT_SECRET: dev-secret-change-me
    ports:
      - "8004:8000"

  booking-service:
    build: ../services/booking-service
    environment:
      SERVICE_NAME: booking-service
      JWT_SECRET: dev-secret-change-me
      CONTROL_PLANE_DATABASE_URL: postgresql+psycopg://cruise:cruise@postgres:5432/cruise
      TENANT_DATABASE_URL_TEMPLATE: postgresql+psycopg://cruise:cruise@postgres:5432/{db}
      PRICING_SERVICE_URL: http://pricing-service:8000
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      EVENTS_EXCHANGE: cruise.events
    depends_on:
      - postgres
      - rabbitmq
      - pricing-service
      - ship-service
    ports:
      - "8005:8000"

  notification-service:
    build: ../services/notification-service
    environment:
      SERVICE_NAME: notification-service
      JWT_SECRET: dev-secret-change-me
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      EVENTS_EXCHANGE: cruise.events
    depends_on:
      - rabbitmq
    ports:
      - "8006:8000"

  edge-api:
    build: ../services/edge-api
    environment:
      SERVICE_NAME: edge-api
      JWT_SECRET: dev-secret-change-me
      SHIP_SERVICE_URL: http://ship-service:8000
      CRUISE_SERVICE_URL: http://cruise-service:8000
      CUSTOMER_SERVICE_URL: http://customer-service:8000
      BOOKING_SERVICE_URL: http://booking-service:8000
      PRICING_SERVICE_URL: http://pricing-service:8000
      NOTIFICATION_SERVICE_URL: http://notification-service:8000
    depends_on:
      - ship-service
      - cruise-service
      - customer-service
      - booking-service
      - pricing-service
      - notification-service
    ports:
      - "8000:8000"

  admin-portal:
    build: ../services/admin-portal
    environment:
      # Used by the frontend at build/runtime (nginx serves static)
      VITE_EDGE_API_URL: http://localhost:8000
    depends_on:
      - edge-api
    ports:
      - "3000:80"
